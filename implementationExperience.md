# Implementation Experience

## What is happening here?
I'll follow the steps and take notes of the results when following the set up procedure proposed in this repository.

## Goal
Create a working customizable WiFi HaLow network.

## Environment

### Main elements
- Raspberry Pi 3 B+
- AHPI7292S WiFi HaLow™ Raspberry Pi™ HAT module
- 868 MHz antenna compatible with WiFi HaLow HAT

### Accesories
- Power supply [element14] 2.5 A, 5.1 V, micro USB B
- SD card 32 GB with FAT32 file format
- USB Keyboard
- USB Mouse
- HDMI screen

### Services 
- Interntet connection
- Electricity supply

### Code elements
- [nrc7292_sw_pkg](https://github.com/newracom/nrc7292_sw_pkg) repository

## Steps take
### SD card set up
- Format the SD card to FAT32 filesystem: done with Windows disk management tool
- Flash two SD cards with official Raspberry Pi OS (32-bit) image, one is for client and another is for AP (step 1 from [ALFA](https://docs.alfa.com.tw/Product/AHPI7292S/20_Getting_Started_New/): done with the [Raspberry Pi Imager](https://www.raspberrypi.com/software/)
 - Options used:
  - Raspberry Pi Device: RASPBERRY PI 3
  - Operating system: RASPBERRY PI OS (32-BIT) Released 2025-05-13
  - Storage: SD card
  - Hostname: ietr.local
  - User: root
  - Pass: root
  - No WLAN configured
  - Services: SSH enabled with password authentication
  - Options: all 3 checked (play sound when finished, eject media when finished, enable telemetry)
  - Apply configuration -> Yes
  - Accept currente content being erased? -> Yes
  - Configuration time: ~4 minutes

### Rasperry Pi set up
- Take the SD card and put in the slot from the Raspberry 3
- Complete the bench set up for working with the Raspberry Pi: mouse, keyboard, screen, power supply, HAT, and antenna (see step 2 from [ALFA](https://docs.alfa.com.tw/Product/AHPI7292S/20_Getting_Started_New/))
- Start the the Raspberry Pi, intial starting time took ~2 minutes
- Initial set up
  - Country: France
  - Language: French
  - Timezone: Paris
  - Use English language: box checked
  - Use US keyboard: box unchecked
  - Press Next
  - Wait for ~1 linute
- Follow step 3 from [ALFA](https://docs.alfa.com.tw/Product/AHPI7292S/20_Getting_Started_New/)
  - username: pi
  - password: pi
    - An alert message is received stating that we are using a known default value for the username or password, system reccomend to change it -> OK
  - WiFi network: Internet connection provided by cellphone. In case Internet connection is provided by Bluetooth or Ethernet, just skip this part.
  - Browser choice: Chromium selected, also I have checked the box to have Firefox uninstalled.
  - Next
  - Update software: I should have the latest software since I have just download it, anyway I will check if there is any update -> (clock synchronisation...) "Error: could not sync time - unable to check updates"
  - OK
  - Restart (takes ~1 minute)
Raspberry PI is ready. Now, as far as we know, we could either continue with [ALFA's](https://docs.alfa.com.tw/Product/AHPI7292S/20_Getting_Started_New/) steps --the HAT manufacturer-- (now we should go for step 4) ==OR== we could follow Newracom's steps --the chip manufacturer--. Due to previous positive experience with Newracom's information and support, we will take their path.

### Newracoms steps

The set up mode we have chosen is ==Host==. For context information, the Standalone mode is also available.

For the Host mode, we will look for the steps proposed by Newracoms in their GitHub repository.
- Open browser -> Go to Newracom's repository in GitHub -> Look for the nrc_7292_sw_pck repository and download it (took 5 to 10 minutes)
- Open CLI -> Locate the downloaded file in the Downloads' folder -> Move the file to ~/ ``mv nrc7292_sw_pkg-master.zip ~/``
- Unzip the file ``unzip nrc7292_sw_pkg-master.zip`` (takes ~1 minute)
- Execute:
  - ``cd /boot/overlays`` OK
  - ``sudo dtc -I dts -O dtb -o newracom.dtbo newracom.dts`` FATAL ERROR: "newracom.dts": No such file or directory.
    - I changed the command to  ``sudo dtc -I dts -O dtb -o newracom.dtbo ~/nrc7292_sw_pkg-master/dts/newracom.dts`` for the command to correctly locate the input file.
    - Command was executed and threw a warning message: "/home/pi/nrc7292_sw_pkg-master/dts
/newracom.dts:16.12-18.6: Warning (unit_address_cs_reg): /fragment@0/__overlay/__spidev@0: node has a unit name, but no reg or ranges property"
    - Inspecting /boot/overlays I find a file called "newracom.dtbo", so let's say that we can move forward.
  - Next command is ``sudo vi /boot/config.txt`` + ``dtoverlay=newracom ``
    - Once I execute the first part I get to a file where I can see a "DO NOT EDIT THIS FILE" and "The file you are looking for has moved to /boot/firmware/config.txt"
    - So, now I do ``sudo vi /boot/firmware/config.txt`` and I have arrived to the good file (I hope...). Now I need to check where should I insert the ``dtoverlay=newracom `` because it is defined already 2 times in the original file.
    - By reading [Raspberry Pi documentation](https://www.raspberrypi.com/documentation/computers/configuration.html#part3.1), I undestand that multiple overlays can be added, thereforo I will try adding the line ``dtoverlay=newracom `` to the file at the end. Also the README file at ``/boot/firmware/overlays`` provides additional information.
     - I created the file copied the file ``config.txt`` as ``config.txt.old`` to preserve the original one. Then edited ``config.txt``.
  - Now the **Install release package** step
   - I created the new folder ``~/swp_kg`` with ``mkdir -p ~/swp_kg``
   - Copied the ``swp_kg`` folder in the new location: ``cp -r ~/nrc7292_sw_pkg-master/package/evk/sw_pkg/* ~/sw/pkg``
   - I change location to the new folder: ``cd ~/swp_kg``
   - Run the command ``chmod +x ./update.sh`` -> OK
   - Run the command ``./update.sh`` -> OK
  - Step **(Optional) Install firmware/driver/cli_app binaries** -> DONE
   - ``cd  ~/nrc7292_sw_pkg-master/package/evk/binary`` (adapted from ``cd evk/binary``)
   - ``cp ./cli_app ~/nrc_pkg/script`` -> OK
   - ``cp ./nrc.ko ~/nrc_pkg/sw/driver`` -> OK
   - ``cp ./nrc7292_cspi.bin ~/nrc_pkg/sw/firmware`` -> OK
  - Step **(Optional) Build host driver** -> **NOT** DONE
  - Step **Apply a specific package** -> **NOT** DONE
   - What is my current package ? I downloaded the last release, so currently I should be working with 1.5.2
   - Version 1.5.2, checked on the ``README.md`` file at ``~/nrc7292_sw_pkg-master/``
- The moment of truth: **Run NRC7292 Software Package**
 - **Configure start script**
  - Start parameter can be changed with: ``vi nrc_pkg/script/start.py`` -> No changes done, just inspected it.
 - **Test run**
  - To run an **AP** we will use the following command:
   - ``cd ~/nrc_pkg/script``
   - Run ``./start.py 1 0 EU`` -> This means: _OPEN_ mode _AP_ for _Europe_
    - Results:
     - "Selected interface 'wlan0' FAIL (2 times)
     - "sudo: iptables: command not found" (2 times)
     - "Failed to stop dhcpcd.service: Unit dhcpcd.service not loaded."
     - "Failed to stop dnsmasq.service: Unit dnsmasq.service not loaded."
    - So, I install iptables ``sudo apt install iptables`` -> Installation OK
    - Run again ``./start.py 1 0 EU``
     - No more "sudo: iptables: command not found" error message
     - When having an active WiFi connection, the "Selected interface 'wlan0' FAIL" message changes to "Selected interface 'wlan0' OK"
     - Still having both "Failed to stop dhcpcd.service: Unit **dhcpcd.service** not loaded." & "Failed to stop **dnsmasq.service**: Unit dnsmasq.service not loaded."
     - Config files of both services are available at ``/etc`` (see ``dhcpcd.conf`` and ``dnsmasq.conf``)
    - Tried ``./start.py 0 0 EU``  -> This means: _OPEN_ mode _STA_ for _Europe_
     - Same errors: "Failed to stop dhcpcd.service: Unit **dhcpcd.service** not loaded." & "Failed to stop **dnsmasq.service**: Unit dnsmasq.service not loaded."
     - Program does not finish and waits for IP.
     - Actually, that would be alright, since in the end is the Halow AP who will provide the IP. Apparently, both WiFI legacy and WiFi Halow use the same service (dhcpcd).

Before continuing with the troubleshooting I will set up a sencond Raspberry Pi. For the AP I would expect to have a different config since it will be responsible for the IP assignment. Maybe I am missing setting an a fixed IP for the AP since no one is assigning it an IP. Still, due to the way the "start" command is proposed to be executed, does not seem that it should be done. Anyway, I will check.

### 2nd Raspberry Pi

SD Card formatting
- All partitions deleted
- New single volume defined for the whle SD card. Volume name: RPi3B-002 (the first one I did I am not sure if I called it "RPi3B-001" or "RPi3-001" ("quick formatting" unchecked, took ~15 minutes)
- Image creation: same parameters as in the first one.
Raspberry Pi 1st start:
- Set up prepared: Raspbeeey Pi + SD Card + Mouse + Keyboard + Antenna 868 MHz + Power supply
- Raspberry 1st start: Mouse not recornized (it works with my laptop though...)
 - Steps: same as before. No update check, no WiFi connection configured for the moment.
 - Next: change mouse, attach to WiFi and reach the same step as with the other Raspberry Pi (from now on R-01) --  Got the mouse!
Configuring the Raspberry Pi after 1st start (i.e., continue with Newracom steps)
 - We will work in Host mode as well.
 - Provide internet connenction with cellphone
 - Access and download repository

 
 - Open CLI -> Locate the downloaded file in the Downloads' folder -> Move the file to ~/ ``mv nrc7292_sw_pkg-master.zip ~/``
- Unzip the file ``unzip nrc7292_sw_pkg-master.zip`` (takes ~1 minute)
- Execute:
  - ``cd /boot/overlays`` OK
  - ``sudo dtc -I dts -O dtb -o newracom.dtbo newracom.dts`` FATAL ERROR: "newracom.dts": No such file or directory.
    - I changed the command to  ``sudo dtc -I dts -O dtb -o newracom.dtbo ~/nrc7292_sw_pkg-master/dts/newracom.dts`` for the command to correctly locate the input file.
    - Command was executed and threw a warning message: "/home/pi/nrc7292_sw_pkg-master/dts
/newracom.dts:16.12-18.6: Warning (unit_address_cs_reg): /fragment@0/__overlay/__spidev@0: node has a unit name, but no reg or ranges property"
    - Inspecting /boot/overlays I find a file called "newracom.dtbo", so let's say that we can move forward.
  - Config file edition
   - Go to the folder ``cd /boot/firmware`` Make a copy of the config file ``sudo cp config.txt config.txt.old``
  - Next command is ``sudo vi config.txt`` + adding the line ``dtoverlay=newracom`` after the lines ``[cm5]`` and ``dtoverlay=dwc2,dr_mode=host``, and before ``[all]``. Escape the insert mode with the "ESC" key, then save and exit the file with the ``:wq`` command. Re-enter the file and check thqt the edition is good.
- Now the **Install release package** step
 - I created the new folder ``~/sw_pkg`` with ``mkdir -p ~/sw_pkg``
 - Copied the ``sw_pkg`` folder in the new location: ``cp -r ~/nrc7292_sw_pkg-master/package/evk/sw_pkg/* ~/sw_pkg``
 - I change location to the new folder: ``cd ~/sw_pkg``
 - Run the command ``chmod +x ./update.sh`` -> OK
 - Run the command ``./update.sh`` -> OK
- Step **(Optional) Install firmware/driver/cli_app binaries** -> DONE
 - ``cd  ~/nrc7292_sw_pkg-master/package/evk/binary``
 - ``cp ./cli_app ~/nrc_pkg/script`` -> OK
 - ``cp ./nrc.ko ~/nrc_pkg/sw/driver`` -> OK
 - ``cp ./nrc7292_cspi.bin ~/nrc_pkg/sw/firmware`` -> OK
- Step **(Optional) Build host driver** -> **NOT** DONE
- Step **Apply a specific package** -> **NOT** DONE
 - What is my current package ? Version 1.5.2, checked on the ``README.md`` file at ``~/nrc7292_sw_pkg-master/``
- The moment of truth: **Run NRC7292 Software Package**
 - **Configure start script**
  - Start parameter can be changed with: ``vi nrc_pkg/script/start.py`` -> No changes done, just inspected it.
 - **Test run**
  - To run an **AP** we will use the following command:
   - ``cd ~/nrc_pkg/script``
   - Run ``./start.py 1 0 EU`` -> This means: _OPEN_ mode _AP_ for _Europe_
    - Results:
     - "Selected interface 'wlan0' OK (2 times) - Beacause I'm connected to a WiFi Legacy network for internet connection.
     - "sudo: iptables: command not found" (2 times)
     - "Failed to stop dhcpcd.service: Unit dhcpcd.service not loaded."
     - "Failed to stop dnsmasq.service: Unit dnsmasq.service not loaded."
    - So, I install iptables ``sudo apt install iptables`` -> Installation OK
    - Run again ``./start.py 1 0 EU``
     - No more "sudo: iptables: command not found" error message
     - Still having both "Failed to stop dhcpcd.service: Unit **dhcpcd.service** not loaded." & "Failed to stop **dnsmasq.service**: Unit dnsmasq.service not loaded."
     - Config files of both services are available at ``/etc`` (see ``dhcpcd.conf`` and ``dnsmasq.conf``)
    - Tried ``./start.py 0 0 EU``  -> This means: _OPEN_ mode _STA_ for _Europe_
     - Same errors: "Failed to stop dhcpcd.service: Unit **dhcpcd.service** not loaded." & "Failed to stop **dnsmasq.service**: Unit dnsmasq.service not loaded."
     - Program does not finish and waits for IP.
     - Actually, that would be alright, since in the end is the Halow AP who will provide the IP. Apparently, both WiFI legacy and WiFi Halow use the same service (dhcpcd).
    
I will need to pay attencion to the linux version on the RPi3 and follow the integration guide of Newracom UG-7292-018-Raspberry_Pi_setup "NRC7292 Evaluation Kit User Guide (Raspberry Pi setup)".

Update May-15 2025: S achieved to have a working unit. The current issue has to do with the current version of Linux being used (Raspberry Pi OS with desktop; Release date: May 13th 2025; System: 3 2-bitKernel version: 6.12; Debian version: 12 (bookworm)). He recompiled the SW using an older vesion and it worked perfectly on a single node. We will clone the SD Card and test a link between two stations (STA+AP). In paralel S will compile the application with a more recent Linux version for the Raspberry Pi so we can work with the most recent compatible version.

Update May-16 2025: SD Cardcloning process
 - [Steps followed](https://raspberrytips.com/how-to-clone-raspberry-pi-sd-card/#clone-sd-card-using-win32-disk-imager-windows) for image creation
  - Image creation based on S's succesful implementation: OK. Image name: "2025-05-15_RPiHalowImage.img" Available at I's PC. Took ~6 minutes.
  - Image writing on a new SD Card: OK. Took ~20 minutes.
  - Boot crashes
  - Did not work
 - [New steps followed](https://www.tomshardware.com/how-to/back-up-raspberry-pi-as-disk-image)
  - Format a USB Flash in NTFS (option for Windows users). I'll call it piHalow.
  - Issue when connecting the Raspberry that S prepared due to the config used.
  - Path not followed
S has prepared the SD cards with his PC.

We have found that is not possible to flash a SD card that works independently of the Raspberry Pi used. Therefore we changed the flashing done to the SD cards in order to only be a software image that we know that is compatible with the Newracom drivers. So we work with linux version 6.1. We move forward towards the procedure proposed at "UG-7292-018-Raspberry_Pi_setup.pdf".

We are going to work with all 6.1 versions of Linux. We will continue to set up the rest of the boards, then we will put toghether a network with one STA, one AP and a sniffer.

### Basic operational network

We have two nodes working at the lab. ONe as AP, the other as a STA.

Config AP:
- Linux version 6.1
- User: pi
- Pass: rtlry
- Commands for starting the node:
```
cd ~/nrc_pkg/script/
./start.py 1 0 EU
```
- Commands for stopping the node:
```
./stop.py
```

### Node set up
The document to follow in this instance is the "UG-7292-018-Raspberry_Pi_setup" by Newracom. We are going to have to pay attention to a database file called "(?)_bd.dat". Since the HAT we are using is manufactured by ALFA using Newracom's chip, this specific should be retrieved from ALFA's files.

So, last time I finished the step 3.1 in "UG-7292-018-Raspberry_Pi_setup" called "Enable the required interfaces". The issue here is since we do not have an open Ethernet connection we use a WiFi link using our cellphones. So we need to address all the internet-related steps before deactivationg the Wifi interface.

Steps requiring internet connection
- Step 3.2:
  - ``sudo apt update``
  - ``sudo apt upgrade``
  - ``sudo apt install raspberrypi-bootloader raspberrypi-kernel``
  - ``sudo apt install raspberrypi-kernel-headers``
  - ``sudo apt install vim iperf iperf3``
- Step Kernel Build (Optional): for the moment we are not going to follow it.
- Step 3.3 "Disable Broadcom Wi-Fi and Bluetooth": we will evaluate if we can postpone this step without major issues  
- Step 3.4 "Disable User mode SPI device driver" no internet-related steps
- Step 3.5 "Packages and configurations required for Newracom Wi-Fi"
  - ``sudo apt install hostapd dnsmasq``
- "4.1 Download and install the package from GitHub repository"
  - ``git clone https://github.com/newracom/nrc7292_sw_pkg.git`` This is the last step that requires internet.

I try to do the internet related steps in advance, so that I deviate as minimum as possible from the procedure.
- ``uname -a`` response: Linux ietr 6.1.27-v7+ #1642 SMP Mon Apr 3 17:20:52 BST 2023 armv7l GNU/Linux
- ``ls -l /lib/modules`` response 6.1.21+, 6.1.21-v7+, 6.1.21-v7l+, 6.1.21-v8+
- ``sudo apt install raspberrypi-bootloader raspberrypi-kernel`` response: already up to date
- I did the reboot anyway and follow the steps
- ``sudo apt install raspberrypi-kernel-headers``: OK
- ``ls -l /usr/src`` response: linux-headers-6.1.21+, linux-headers-6.1.21-v7+, linux-headers-6.1.21-v7l+, sense-hat
- ``sudo apt install vim iperf iperf3``: failed vim & iperf3 install. I ran ``sudo apt update`` and the re-ran the command: OK
- I will run the command ``sudo apt install hostapd dnsmasq`` now: OK
- Download the repository from git: ``git clone https://github.com/newracom/nrc7292_sw_pkg.git``
- Once the repository is cloned I will continue with the step 3.3
  - ``ls -l /boot/overlays/disable-*``: apart from "disable-bt.dtbo" and "disqble-wifi.dtbo", there is a "disable-emmc2.dtbo" file also
  - ``sudo vim /boot/config.txt`` I used "nano" instead of "vim" just because I like it better: I added the 3 lines at the end leaving a line in between the original code and the added lines.
  - ``sudo reboot``: no more wifi, nor Bluetooth, nor spi-dev. Pop up notifications at desktop confirmed the unavailability of these interfaces.  
  - ``ifconfig -a`` only "eth0" and "lo" apper as available
- Step 3.4
  - I used as a template the file "newracom_for_5.16_or_later.dts" in ~/nrc7292_sw_pkg/dts copied and pasted it in ~/ and added 3 missing lines:
```
spidev@1{
 status = "disabled";
};
```
 - ``dtc -I dts -O dtb -o newracom.dtbo newracom.dts``: OK, two warnings popped up, no action taken.
  - ``/fragment0/__overlay__/spidev@0: node has a unit name, buit no reg property``
  - ``/fragment0/__overlay__/spidev@1: node has a unit name, buit no reg property``
 - ``sudo cp newracom.dtbo /boot/overlays/``: OK
 - ``sudo nano /boot/config.txt``
  - I will erase the  ``dtoverlay= pi3-disable-spidev`` that I have added and then written the ``dtoverlay=newracom`` line
  - ``sudo reboot``
  - ``ls -l /dev/spidev*``: OK, I received the response expected:  "ls: cannot access '/dev/spidev*': No such file or directory"
- Step 3.5
```
cd /etc/wpa_supplicant/
sudo mv wpa_supplicant.conf wpa_supplicant.conf.unused
```
  - OK
  - ``sudo nano /etc/modules``: OK
  - ``sudo nano /etc/modprobe.d/raspi-blacklist.conf`` : OK
- Step 4.1
  - ``cd nrc7292_sw_pkg/package/evk/sw_pkg``
  - ``chmod +x update.sh``: OK
  - ``./update.sh``: OK
- Step 4.2
  - ``cd ~/ nrc7292_sw_pkg/package/src/nrc``
  - ``make``: OK
  - ``cp -b nrc.ko ~/nrc_pkg/sw/driver``
  - ``ls -l ~/nrc_pkg/sw/driver``: OK, response expected. There is also a README file.
- Step 4.3 "Start Newracom Wi-Fi in AP or STA mode": Please refer to the Host Mode User Guide on how to get started.
  - I'm going to try to lauch the AP with ``./start.py 1 0 EU`` at ``~/nrc_pkg/script``
   - Launch failed. Console messages:
```
...
[2] Set initial country
[3] Loading module
sudo insmod /home/pi/nrc_pkg/sw/driver/nrc.ko fw_name=uni_s1g.bin bss_max_idle=1800 ndp_preq=1 listen_interval=1000 bd_name=nrc7292_bd.dat
insmod: ERROR: could no insert module /home/pi/nrc_pkg/sw/driver/nrc.ko: Unknown symbol in module
wlan0: ERROR while getting interface flags: no such device
rmmod: ERROR: Module nrc is not currently loaded
```
 - Reboot & check switch: switch was on "Standalone", changed to "Host" 
 - Launch retry: SUCCESS
 - I have lauched the other two RPis as well, so I have the following setup:
   - Far right (this last one) | Mode AP | MAC: ``44:c3:06:00:08:ee`` | IP: 192.168.200.1
   - Middle | Mode STA | MAC: ``44:c3:06:00:08:f0`` | IP: 192.168.200.29
   - Far left | Mode STA | MAC: ``44:c3:06:00:08:ea`` | IP: 192.168.200.23
  
Update from May 23th:
- S has prepared all 5 RPis available with the same software (Linux 6.1)

Update from May 27th:
- Tested system operation with the updated setup: OK
- S used US frequencies on his tests, I've tried with EU frequency (channel 36).
  - Start commands used:
    - STA: ``./start.py 0 0 EU``
    - AP: ``./start.py 1 0 EU``
    - Sniffer: ``./start.py 2 0 EU 36 0``
  - Then I've run a ping command between AP and STA and saw the sniffing results: OK, the sniffer was capable of catching the messages in the wireshark interface.
- Regarding the attack, I want to replicate the scenario, therefor I need to set up a exchange od UDP packages between the AP and the STA. TO be more consistent with the simularion those should be packages sent only one way from STA to AP.
- To install a UDP service I'm thinking of working with [this](https://wiki.python.org/moin/UdpCommunication) and [this](https://forums.raspberrypi.com/viewtopic.php?t=319674)
- Another idea in mind is set up an [Express](https://expressjs.com/) app and create a web server that do some exchange between STA and AP or between STA and other STA.
- For any of the previous proposal we'll need internet access to allow us to download packages for implementing any app. Hopefully tomorrow we'll have an update from the IT team.
- Once the service is placed we need to execute the attack, so we may need to creat an additional services that crashes the app based on the same principle of the referenced article. How we'll do that? No one knows... YET!
